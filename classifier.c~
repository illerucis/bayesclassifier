struct bclassifier {

    int ngroups;
    int nvars;
    int nsamples;

    double *tdata;
    double *stats;

};

struct bclassifier getclassifier(double tdata[], int ngroups, int nvars, int nsamples)
{
    struct bclassifier b;
    
    double *atdata = malloc(ngroups*nvars*nsamples*sizeof(double));
    if (atdata == NULL) return -1; 

    atdata = tdata;

    b->ngroups = ngroups;
    b->nvars = nvars;
    b->nsamples = nsamples;
    b->tdata = atdata;

    return b;
}


double getmean(double stats[], int nsamples)
{
    double sum = 0.0;
    for (int i = 0; i < nsamples; i++)
	sum += stats[i];
    return sum / nsamples;
}

double getvariance(double stats[], int nsamples)
{
    double var = 0.0;
    double mean = getmean(stats, nsamples);
    for (int i = 0; i < nsamples; i++) 
	var += (stats[i] - mean) * (stats[i] - mean);
    return ( 1 / ( nsamples - 1.0 ) ) * var; 
}

double getprob(double mean, double var, double val)
{
    double a = 1 / (sqrt(2*M_PI*var));
    double b = ( - (val - mean)*(val - mean) / (2*var) );
    return a*exp(b);
}

void train(struct bclassifier *b)
{

    int ngroups = b->ngroups;
    int nvars = b->nvars;
    int nsamples = b->nsamples;
    
    double *stats = malloc
    double stats[ngroups][nvars][2];

    double *tdata = b->tdata;

    for (int g = 0; g < ngroups; g++) {
	double *garr = tdata + g;
	for (int v = 0; v < nvars; v++) {
	    stats[g][v][0] = getmean((garr + v), nsamples);
	    stats[g][v][1] = getvariance((garr + v), nsamples);
	}
    }

    b->stats = &stats;
}

int classify(struct bclassifier *b, double input[])
{
    int ngroups = b->ngroups;
    int nvars = b->nvars;

    double *tdata = b->tdata;
    double cprobs[ngroups];    
    double cpmax = 0.0;
    double cp;

    int gmax = -1;

    // find the greatest numerator
    for (int g = 0; g < ngroups; g++) {
	cp = 1.0;
	double *garr = tdata + g;
	for (int v = 0; v < nvars; v++) {
	    double *varr = garr + v;
	    cp = cp*getprob(*(varr), *(varr + 1), input[v]);
	}
	if (cp > cpmax) {
	    cpmax = cp;
	    gmax = g;
	}
    }

    return gmax;

}

